<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>版本更新/升级操作 on FastGPT</title><link>/docs/development/upgrading/</link><description>Recent content in 版本更新/升级操作 on FastGPT</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><atom:link href="/docs/development/upgrading/index.xml" rel="self" type="application/rss+xml"/><item><title>升级说明</title><link>/docs/development/upgrading/intro/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>/docs/development/upgrading/intro/</guid><description>FastGPT 升级包括两个步骤：
镜像升级 执行升级初始化脚本 镜像名 linkgit版
FastGPT 主镜像：ghcr.io/labring/fastgpt:latest 商业版镜像：ghcr.io/c121914yu/fastgpt-pro:latest Admin 镜像：ghcr.io/c121914yu/fastgpt-admin:latest 阿里云
FastGPT 主镜像: registry.cn-hangzhou.aliyuncs.com/fastgpt/fastgpt 商业版镜像：ghcr:registry.cn-hangzhou.aliyuncs.com/fastgpt/fastgpt-pro Admin 镜像: registry.cn-hangzhou.aliyuncs.com/fastgpt/fastgpt-admin 镜像由镜像名和Tag组成，例如: registry.cn-hangzhou.aliyuncs.com/fastgpt/fastgpt:v4.6.1 代表4.6.3版本镜像，具体可以看 docker hub, github 仓库。
Sealos 修改镜像 link 打开 Sealos Cloud， 找到桌面上的应用管理 选择对应的应用 - 点击右边三个点 - 变更 修改镜像 - 确认变更
如果要修改配置文件，可以拉到下面的配置文件进行修改。
Docker-Compose 修改镜像 link直接修改yml文件中的image: 即可。随后执行:
docker-compose pull docker-compose up -d 执行升级初始化脚本 link镜像更新完后，可以查看文档中的版本介绍，通常需要执行升级脚本的版本都会标明需要初始化，打开对应的文档，参考说明执行初始化脚本即可，大部分时候都是需要发送一个POST请求。
QA link{{host}} 是什么 link{{}} 代表变量， {{host}}代表一个名为 host 的变量。指的是你服务器的域名或 IP。
Sealos 中，你可以在下图中找到你的域名：
如何获取 rootkey link从docker-compose.yml中的environment中获取，对应的是ROOT_KEY的值。
sealos 中可以从上图左侧的环境变量中获取。
如何跨版本升级！！ link建议逐一版本升级，防止脏数据。例如，当前版本是4.</description></item><item><title>V4.6.6（需要改配置文件）</title><link>/docs/development/upgrading/466/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>/docs/development/upgrading/466/</guid><description>配置文件变更 link为了减少代码重复度，我们对配置文件做了一些修改：点击查看最新的配置文件
V4.6.6 更新说明 link 查看 FastGPT 2024 RoadMap 新增 - Http 模块请求头支持 Json 编辑器。 新增 - ReRank模型部署 新增 - 搜索方式：分离向量语义检索，全文检索和重排，通过 RRF 进行排序合并。 优化 - 问题分类提示词，id引导。测试国产商用 api 模型（百度阿里智谱讯飞）使用 Prompt 模式均可分类。 UI 优化，未来将逐步替换新的UI设计。 优化代码：Icon 抽离和自动化获取。 修复 - 链接读取的数据集，未保存选择器，导致同步时不使用选择器。</description></item><item><title>V4.6.5（需要改配置文件）</title><link>/docs/development/upgrading/465/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>/docs/development/upgrading/465/</guid><description>配置文件变更 link由于 openai 已开始弃用 function call，改为 toolChoice。FastGPT 同步的修改了对于的配置和调用方式，需要对配置文件做一些修改：
点击查看最新的配置文件
主要是修改模型的functionCall字段，改成toolChoice即可。设置为true的模型，会默认走 openai 的 tools 模式；未设置或设置为false的，会走提示词生成模式。 问题补全模型与内容提取模型使用同一组配置。
增加 &amp;quot;ReRankModels&amp;quot;: [] V4.6.5 功能介绍 link 新增 - 问题补全模块 新增 - 文本编辑模块 新增 - 判断器模块 新增 - 自定义反馈模块 新增 - 【内容提取】模块支持选择模型，以及字段枚举 优化 - docx读取，兼容表格（表格转markdown） 优化 - 高级编排连接线交互 优化 - 由于 html2md 导致的 cpu密集计算，阻断线程问题 修复 - 高级编排提示词提取描述</description></item><item><title>V4.6.4(需要初始化)</title><link>/docs/development/upgrading/464/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>/docs/development/upgrading/464/</guid><description>1。执行初始化 API link发起 1 个 HTTP 请求 ({{rootkey}} 替换成环境变量里的 rootkey，{{host}} 替换成自己域名)
https://xxxxx/api/admin/initv464 curl --location --request POST &amp;#39;https://{{host}}/api/admin/initv464&amp;#39; \ --header &amp;#39;rootkey: {{rootkey}}&amp;#39; \ --header &amp;#39;Content-Type: application/json&amp;#39; 初始化说明：
初始化 PG 的createTime字段 初始化 Mongo 中 chat 的 feedback 字段 V4.6.4 功能介绍 link 重写 - 分享链接身份逻辑，采用 localID 记录用户的ID。 商业版新增 - 分享链接 SSO 方案，通过身份鉴权地址，仅需3个接口即可完全接入已有用户系统。具体参考分享链接身份鉴权 新增 - 分享链接更多嵌入方式提示，更多DIY方式。 优化 - 历史记录模块。弃用旧的历史记录模块，直接在对应地方填写数值即可。 调整 - 知识库搜索模块 topk 逻辑，采用 MaxToken 计算，兼容不同长度的文本块 调整鉴权顺序，提高 apikey 的优先级，避免cookie抢占 apikey 的鉴权。 链接读取支持多选择器。参考Web 站点同步用法 修复 - 分享链接图片上传鉴权问题 修复 - Mongo 连接池未释放问题。 修复 - Dataset Intro 无法更新 修复 - md 代码块问题 修复 - root 权限问题 优化 docker file</description></item><item><title>V4.6.3(需要初始化)</title><link>/docs/development/upgrading/463/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>/docs/development/upgrading/463/</guid><description>1。执行初始化 API link发起 1 个 HTTP 请求 ({{rootkey}} 替换成环境变量里的 rootkey，{{host}} 替换成自己域名)
https://xxxxx/api/admin/initv463 curl --location --request POST &amp;#39;https://{{host}}/api/admin/initv463&amp;#39; \ --header &amp;#39;rootkey: {{rootkey}}&amp;#39; \ --header &amp;#39;Content-Type: application/json&amp;#39; 初始化说明：
初始化Mongo 中 dataset，collection 和 data 的部分字段 V4.6.3 功能介绍 link 商业版新增 - web站点同步 新增 - 集合元数据记录 优化 - url 读取内容 优化 - 流读取文件，防止内存溢出 优化 - 4v模型自动将 url 转 base64，本地也可调试 优化 - 图片压缩等级 修复 - 图片压缩失败报错，防止文件读取过程卡死。</description></item><item><title>V4.6.2(需要初始化)</title><link>/docs/development/upgrading/462/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>/docs/development/upgrading/462/</guid><description>1。执行初始化 API link发起 1 个 HTTP 请求 ({{rootkey}} 替换成环境变量里的 rootkey，{{host}} 替换成自己域名)
https://xxxxx/api/admin/initv462 curl --location --request POST &amp;#39;https://{{host}}/api/admin/initv462&amp;#39; \ --header &amp;#39;rootkey: {{rootkey}}&amp;#39; \ --header &amp;#39;Content-Type: application/json&amp;#39; 初始化说明：
初始化全文索引 V4.6.2 功能介绍 link 新增 - 全文索引（需配合 Rerank 模型，在看怎么放到开源版，模型接口比较特殊） 新增 - 插件来源（预计4.7/4.8版本会正式使用） 优化 - PDF读取 优化 - docx文件读取，转成 markdown 并保留其图片内容 修复和优化 TextSplitter 函数</description></item><item><title>V4.6.1</title><link>/docs/development/upgrading/461/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>/docs/development/upgrading/461/</guid><description>V4.6.1 功能介绍 link 新增 - GPT4-v 模型支持 新增 - whisper 语音输入 优化 - TTS 流传输 优化 - TTS 缓存</description></item><item><title>V4.6(需要初始化)</title><link>/docs/development/upgrading/46/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>/docs/development/upgrading/46/</guid><description>V4.6 版本加入了简单的团队功能，可以邀请其他用户进来管理资源。该版本升级后无法执行旧的升级脚本，且无法回退。
1。更新镜像并变更配置文件 link更新镜像至 latest 或者 v4.6 版本。商业版镜像更新至 V0.2.1
最新配置可参考：V46 版本最新 config.json，商业镜像配置文件也更新，参考最新的飞书文档。
2。执行初始化 API link发起 2 个 HTTP 请求 ({{rootkey}} 替换成环境变量里的 rootkey，{{host}} 替换成自己域名)
该初始化接口可能速度很慢，返回超时不用管，注意看日志即可，需要注意的是，需确保 initv46 成功后，在执行 initv46-2
https://xxxxx/api/admin/initv46 curl --location --request POST &amp;#39;https://{{host}}/api/admin/initv46&amp;#39; \ --header &amp;#39;rootkey: {{rootkey}}&amp;#39; \ --header &amp;#39;Content-Type: application/json&amp;#39; https://xxxxx/api/admin/initv46-2 curl --location --request POST &amp;#39;https://{{host}}/api/admin/initv46-2&amp;#39; \ --header &amp;#39;rootkey: {{rootkey}}&amp;#39; \ --header &amp;#39;Content-Type: application/json&amp;#39; 初始化内容： 1。创建默认团队 2。初始化 Mongo 所有资源的团队字段 3。初始化 Pg 的字段 4。初始化 Mongo Data
V4.6 功能介绍 link 新增 - 团队空间 新增 - 多路向量 (多个向量映射一组数据) 新增 - tts 语音 新增 - 支持知识库配置文本预处理模型 线上环境新增 - ReRank 向量召回，提高召回精度 优化 - 知识库导出，可直接触发流下载，无需等待转圈圈 4.</description></item><item><title>V4.5.2</title><link>/docs/development/upgrading/452/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>/docs/development/upgrading/452/</guid><description>功能介绍 linkFast GPT V4.5.2 link 新增 - 模块插件，允许自行组装插件进行模块复用。 优化 - 知识库引用提示。</description></item><item><title>V4.5.1(需进行初始化)</title><link>/docs/development/upgrading/451/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>/docs/development/upgrading/451/</guid><description>执行初始化 API link发起 1 个 HTTP 请求（{{rootkey}} 替换成环境变量里的rootkey，{{host}}替换成自己域名）
https://xxxxx/api/admin/initv451 curl --location --request POST &amp;#39;https://{{host}}/api/admin/initv451&amp;#39; \ --header &amp;#39;rootkey: {{rootkey}}&amp;#39; \ --header &amp;#39;Content-Type: application/json&amp;#39; 初始化内容：
rename 数据库字段 初始化 Mongo APP 表中知识库的相关字段 初始化 PG 和 Mongo 的内容，为每个文件创建一个集合（存储 Mongo 中），并反馈赋值给 PG。 该初始化接口可能速度很慢，返回超时不用管，注意看日志即可
功能介绍 linkFast GPT V4.5.1 link 新增知识库文件夹管理 修复了 openai4.x sdk 无法兼容 oneapi 的智谱和阿里的接口。 修复部分模块无法触发完成事件</description></item><item><title>V4.5(需进行较为复杂更新)</title><link>/docs/development/upgrading/45/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>/docs/development/upgrading/45/</guid><description>FastGPT V4.5 引入 PgVector0.5 版本的 HNSW 索引，极大的提高了知识库检索的速度，比起IVFFlat索引大致有3~10倍的性能提升，可轻松实现百万数据毫秒级搜索。缺点在于构建索引的速度非常慢，4c16g 500w 组数据使用并行构建大约花了 48 小时。具体参数配置可参考 PgVector官方
下面需要对数据库进行一些操作升级：
PgVector升级：Sealos 部署方案 link 点击Sealos桌面的数据库应用。 点击【pg】数据库的详情。 点击右上角的重启，等待重启完成。 点击左侧的一键链接，等待打开 Terminal。 依次输入下方 sql 命令 -- 升级插件名 ALTER EXTENSION vector UPDATE; -- 插件是否升级成功，成功的话，vector插件版本为 0.5.0，旧版的为 0.4.1 \dx -- 下面两个语句会设置 pg 在构建索引时可用的内存大小，需根据自身的数据库规格来动态配置，可配置为 1/4 的内存大小 alter system set maintenance_work_mem = &amp;#39;2400MB&amp;#39;; select pg_reload_conf(); -- 重构数据库索引和排序 REINDEX DATABASE postgres; -- 开始构建索引，该索引构建时间非常久，直接点击右上角的叉，退出 Terminal 即可 CREATE INDEX CONCURRENTLY vector_index ON modeldata USING hnsw (vector vector_ip_ops) WITH (m = 16, ef_construction = 64); -- 可以再次点击一键链接，进入 Terminal，输入下方命令，如果看到 &amp;#34;vector_index&amp;#34; hnsw (vector vector_ip_ops) WITH (m=&amp;#39;16&amp;#39;, ef_construction=&amp;#39;64&amp;#39;) 则代表构建完成（注意，后面没有 INVALID） \d modeldata PgVector升级：Docker-compose.</description></item><item><title>V4.4.7（需执行升级脚本）</title><link>/docs/development/upgrading/447/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>/docs/development/upgrading/447/</guid><description>执行初始化 API link发起 1 个 HTTP 请求（{{rootkey}} 替换成环境变量里的rootkey，{{host}}替换成自己域名）
https://xxxxx/api/admin/initv447 curl --location --request POST &amp;#39;https://{{host}}/api/admin/initv447&amp;#39; \ --header &amp;#39;rootkey: {{rootkey}}&amp;#39; \ --header &amp;#39;Content-Type: application/json&amp;#39; 初始化 pg 索引以及将 file_id 中空对象转成 manual 对象。如果数据多，可能需要较长时间，可以通过日志查看进度。
功能介绍 linkFast GPT V4.4.7 link 优化了数据库文件 crud。 兼容链接读取，作为 source。 区分手动录入和标注，可追数据至某个文件。 升级 openai sdk。</description></item><item><title>V4.4.6</title><link>/docs/development/upgrading/446/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>/docs/development/upgrading/446/</guid><description>功能介绍 link 高级编排新增模块 - 应用调用，可调用其他应用。 新增 - 必要连接校验 修复 - 下一步指引在免登录中身份问题。</description></item><item><title>V4.4.5(需要初始化)</title><link>/docs/development/upgrading/445/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>/docs/development/upgrading/445/</guid><description>执行初始化 API link发起 1 个 HTTP 请求（记得携带 headers.rootkey，这个值是环境变量里的）
https://xxxxx/api/admin/initv445 curl --location --request POST &amp;#39;https://{{host}}/api/admin/initv445&amp;#39; \ --header &amp;#39;rootkey: {{rootkey}}&amp;#39; \ --header &amp;#39;Content-Type: application/json&amp;#39; 初始化了 variable 模块，将其合并到用户引导模块中。
功能介绍 linkFast GPT V4.4.5 link 新增 - 下一步指引选项，可以通过模型生成 3 个预测问题。 商业版新增 - 分享链接限制及 hook 身份校验（可对接已有的用户系统）。 商业版新增 - Api Key 使用。增加别名、额度限制和过期时间。自带 appId，无需额外连接。 优化 - 全局变量与开场白合并成同一模块。</description></item><item><title>升级到 V4.4.2(需要初始化)</title><link>/docs/development/upgrading/442/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>/docs/development/upgrading/442/</guid><description>执行初始化 API link发起 1 个 HTTP 请求 (记得携带 headers.rootkey，这个值是环境变量里的)
https://xxxxx/api/admin/initv442 curl --location --request POST &amp;#39;https://{{host}}/api/admin/initv442&amp;#39; \ --header &amp;#39;rootkey: {{rootkey}}&amp;#39; \ --header &amp;#39;Content-Type: application/json&amp;#39; 会给初始化 Mongo 的 Bill 表的索引，之前过期时间有误。</description></item><item><title>升级到 V4.4.1(需要初始化)</title><link>/docs/development/upgrading/441/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>/docs/development/upgrading/441/</guid><description>执行初始化 API link发起 1 个 HTTP 请求（记得携带 headers.rootkey，这个值是环境变量里的）
https://xxxxx/api/admin/initv441 curl --location --request POST &amp;#39;https://{{host}}/api/admin/initv441&amp;#39; \ --header &amp;#39;rootkey: {{rootkey}}&amp;#39; \ --header &amp;#39;Content-Type: application/json&amp;#39; 会给初始化 Mongo 的 dataset.files，将所有数据设置为可用。</description></item><item><title>升级到 V4.4(需要初始化)</title><link>/docs/development/upgrading/44/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>/docs/development/upgrading/44/</guid><description>执行初始化 API link发起 1 个 HTTP 请求 (记得携带 headers.rootkey，这个值是环境变量里的)
https://xxxxx/api/admin/initv44 curl --location --request POST &amp;#39;https://{{host}}/api/admin/initv44&amp;#39; \ --header &amp;#39;rootkey: {{rootkey}}&amp;#39; \ --header &amp;#39;Content-Type: application/json&amp;#39; 会给初始化 Mongo 的部分字段。</description></item><item><title>升级到 V4.3(需要初始化)</title><link>/docs/development/upgrading/43/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>/docs/development/upgrading/43/</guid><description>执行初始化 API link发起 1 个 HTTP 请求 (记得携带 headers.rootkey，这个值是环境变量里的)
https://xxxxx/api/admin/initv43 curl --location --request POST &amp;#39;https://{{host}}/api/admin/initv43&amp;#39; \ --header &amp;#39;rootkey: {{rootkey}}&amp;#39; \ --header &amp;#39;Content-Type: application/json&amp;#39; 会给 PG 数据库的 modeldata 表插入一个新列 file_id，用于存储文件 ID。
增加环境变量 link增加一个 FILE_TOKEN_KEY 环境变量，用于生成文件预览链接，过期时间为 30 分钟。
FILE_TOKEN_KEY=filetokenkey</description></item><item><title>升级到 V4.2.1</title><link>/docs/development/upgrading/421/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>/docs/development/upgrading/421/</guid><description>私有部署，如果添加了配置文件，需要在配置文件中修改 VectorModels 字段。增加 defaultToken 和 maxToken，分别对应直接分段时的默认 token 数量和该模型支持的 token 上限 (通常不建议超过 3000)
&amp;#34;VectorModels&amp;#34;: [ { &amp;#34;model&amp;#34;: &amp;#34;text-embedding-ada-002&amp;#34;, &amp;#34;name&amp;#34;: &amp;#34;Embedding-2&amp;#34;, &amp;#34;price&amp;#34;: 0, &amp;#34;defaultToken&amp;#34;: 500, &amp;#34;maxToken&amp;#34;: 3000 } ] 改动目的是，我们认为不需要留有选择余地，选择一个最合适的模型去进行任务即可。</description></item><item><title>升级到 V4.2</title><link>/docs/development/upgrading/42/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>/docs/development/upgrading/42/</guid><description>99.9%用户不影响，升级 4.2 主要是修改了配置文件中 QAModel 的格式。从原先的数组改成对象：
&amp;#34;QAModel&amp;#34;: { &amp;#34;model&amp;#34;: &amp;#34;gpt-3.5-turbo-16k&amp;#34;, &amp;#34;name&amp;#34;: &amp;#34;GPT35-16k&amp;#34;, &amp;#34;maxToken&amp;#34;: 16000, &amp;#34;price&amp;#34;: 0 } 改动目的是，我们认为不需要留有选择余地，选择一个最合适的模型去进行任务即可。</description></item><item><title>升级到 V4.1</title><link>/docs/development/upgrading/41/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>/docs/development/upgrading/41/</guid><description>如果您是从旧版本升级到 V4.1，由于新版重新设置了对话存储结构，需要初始化原来的存储内容。
更新环境变量 linkV4.1 优化了 PostgreSQL 和 MongoDB 的连接变量，只需要填 1 个 URL 即可：
注意：/fastgpt 和 /postgres 是指数据库名称，需要和旧版的变量对应。
# mongo 配置，不需要改. 如果连不上，可能需要去掉 ?authSource=admin - MONGODB_URI=mongodb://username:password@mongo:27017/fastgpt?authSource=admin # pg配置. 不需要改 - PG_URL=postgresql://username:password@pg:5432/postgres 初始化 API link部署新版项目，并发起 1 个 HTTP 请求（记得携带 headers.rootkey，这个值是环境变量里的）
https://xxxxx/api/admin/initChatItem</description></item><item><title>升级到 V4.0</title><link>/docs/development/upgrading/40/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>/docs/development/upgrading/40/</guid><description>如果您是从旧版本升级到 V4，由于新版 MongoDB 表变更比较大，需要按照本文档的说明执行一些初始化脚本。
重命名表名 link需要连接上 MongoDB 数据库，执行两条命令：
db.models.renameCollection(&amp;#34;apps&amp;#34;) db.sharechats.renameCollection(&amp;#34;outlinks&amp;#34;) warning 注意：从旧版更新到 V4， MongoDB 会自动创建空表，你需要先手动删除这两个空表，再执行上面的操作。
初始化几个表中的字段 link依次执行下面 3 条命令，时间比较长，不成功可以重复执行（会跳过已经初始化的数据），直到所有数据更新完成。
db.chats.find({appId: {$exists: false}}).forEach(function(item){ db.chats.updateOne( { _id: item._id, }, { &amp;#34;$set&amp;#34;: {&amp;#34;appId&amp;#34;:item.modelId}} ) }) db.collections.find({appId: {$exists: false}}).forEach(function(item){ db.collections.updateOne( { _id: item._id, }, { &amp;#34;$set&amp;#34;: {&amp;#34;appId&amp;#34;:item.modelId}} ) }) db.outlinks.find({shareId: {$exists: false}}).forEach(function(item){ db.outlinks.updateOne( { _id: item._id, }, { &amp;#34;$set&amp;#34;: {&amp;#34;shareId&amp;#34;:item._id.toString(),&amp;#34;appId&amp;#34;:item.modelId}} ) }) 初始化 API link部署新版项目，并发起 3 个 HTTP 请求（记得携带 headers.rootkey，这个值是环境变量里的）
https://xxxxx/api/admin/initv4 https://xxxxx/api/admin/initChat https://xxxxx/api/admin/initOutlink 1 和 2 有可能会因为内存不足挂掉，可以重复执行。</description></item></channel></rss>